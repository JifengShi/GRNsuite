# -*- snakemake -*-
configfile: "workflow/config/config.yaml"  # Only for sample list

rule all:
    input:
        expand("results/{sample}/detected_spikes.csv",
               sample=config["samples"]),
        expand("results/{sample}/waveforms.csv",
               sample=config["samples"])

rule process_raw_data:
    input:
        "data/{sample}.txt",
        "parameters.yaml"
    output:
        "results/{sample}/processed_data.csv"
    params:
        param_file = "parameters.yaml",
        output_dir = lambda wildcards: f"results/{wildcards.sample}"
    log:
        "logs/process_raw_data_{sample}.log"
    run:
        from grnsuite.preprocessing import load_and_process_data
        try:
            load_and_process_data(
                input[0],
                params.output_dir,
                param_file=params.param_file
            )
        except Exception as e:
            print(f"Error: {str(e)}")
            raise

rule detect_spikes:
    input:
        "results/{sample}/processed_data.csv",
        "parameters.yaml"
    output:
        spikes="results/{sample}/detected_spikes.csv",
        waveforms="results/{sample}/waveforms.csv"
    params:
        param_file = "parameters.yaml",
        output_dir = lambda wildcards: f"results/{wildcards.sample}"
    run:
        from grnsuite.spike_detection import detect_and_save_spikes
        detect_and_save_spikes(
            input[0],
            params.output_dir,
            param_file=params.param_file
        )